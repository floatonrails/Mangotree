<!-- Mangotree - Fully Integrated Optimized + Anti-Cheat -->
<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>MangoTree - Farmer of Mangoes (AntiCheat Integrated)</title>
<style>
:root{
  --accent:#ffb347;
  --accent2:#ff914d;
  --panel: rgba(255,255,255,0.06);
  --glass: rgba(255,255,255,0.03);
  --ui-shadow: 0 12px 30px rgba(0,0,0,.25);
}
*{box-sizing:border-box;font-family:Inter, system-ui, -apple-system, 'Trebuchet MS', Roboto, Arial;}
html,body{height:100%;margin:0;background:#071b18;color:#000;overflow:hidden}
.game{position:relative;width:100vw;height:100vh;display:grid;grid-template-columns:1fr 380px;gap:18px;padding:18px;background-size:cover;background-position:center;transition:background-image 1.1s ease;}
.header{grid-column:1/-1;display:flex;justify-content:space-between;align-items:center}
.brand{display:flex;gap:12px;align-items:center}
.logo{font-size:32px;background:linear-gradient(135deg,var(--accent),#ffd36b);width:64px;height:64px;border-radius:12px;display:flex;align-items:center;justify-content:center;box-shadow:var(--ui-shadow)}
.title h1{margin:0;font-size:18px;color:#000}
.hud{display:flex;gap:10px;align-items:center}
.statBox{background:var(--panel);padding:8px 12px;border-radius:10px;min-width:120px;text-align:center}
.bigNum{font-size:18px;font-weight:800}
.langToggle{background:transparent;border:1px solid rgba(255,255,255,.06);padding:6px;border-radius:8px;color:#000;cursor:pointer}

/* Play area */
.play{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:12px;padding:14px;box-shadow:var(--ui-shadow);display:flex;flex-direction:column;min-height:72vh}
.scene{position:relative;flex:1;border-radius:10px;overflow:hidden;display:flex;flex-direction:column;transition:background 1s ease}
.sky{position:relative;height:36%;display:flex;align-items:center;justify-content:space-between;padding:12px}
.sun{font-size:72px;filter:drop-shadow(0 6px 20px #ffd36b);animation:sunPulse 6s ease-in-out infinite}
@keyframes sunPulse{0%{transform:scale(1)}50%{transform:scale(1.18)}100%{transform:scale(1)}}
.birds{font-size:20px;opacity:.95;animation:birdsFly 18s linear infinite}
@keyframes birdsFly{0%{transform:translateX(-20%)}100%{transform:translateX(120%)}}

.trees{position:absolute;left:6%;bottom:18%;display:flex;gap:18px;pointer-events:none}
.tree{width:140px;height:180px;border-radius:14px;display:flex;align-items:flex-end;justify-content:center;font-size:56px;transform-origin:center bottom;animation:treeSway 4s ease-in-out infinite}
@keyframes treeSway{0%{transform:rotate(0deg)}50%{transform:rotate(2deg)}100%{transform:rotate(0deg)}}

.center{position:relative;display:flex;align-items:center;justify-content:center;flex:1}
.mangoBtn{width:300px;height:300px;border-radius:50%;background:radial-gradient(circle at 30% 25%, #ffd56b 0%, #ff8f4b 60%);display:flex;align-items:center;justify-content:center;font-size:120px;color:#6b2800;box-shadow:0 18px 50px rgba(0,0,0,.32), inset 0 -12px 40px rgba(0,0,0,.08);cursor:pointer;user-select:none;transition:transform .08s}
.mangoBtn:hover{transform:scale(1.04);filter:drop-shadow(0 16px 40px rgba(255,170,70,.25))}
.ground{position:absolute;bottom:0;width:100%;text-align:center;font-size:28px;padding:8px 0;background:linear-gradient(180deg, rgba(0,0,0,0.03), rgba(0,0,0,0.05))}

.hudRow{display:flex;gap:12px;align-items:center;padding-top:8px}
.controls{display:flex;gap:8px}
.btn{background:linear-gradient(180deg,var(--accent),#ff9f4b);border:none;padding:8px 12px;border-radius:8px;font-weight:700;cursor:pointer}
.btn.ghost{background:transparent;border:1px solid rgba(255,255,255,.06);color:#000}

/* Sidebar */
.sidebar{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:12px;border-radius:8px;box-shadow:var(--ui-shadow);height:calc(100vh - 88px);overflow:auto}
.building{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:10px;margin-bottom:10px;background:var(--glass)}
.upgGrid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.upgrade{background:rgba(255,255,255,0.03);padding:8px;border-radius:8px;font-size:13px}
.achRow{display:flex;gap:8px;flex-wrap:wrap}
.ach{background:rgba(255,255,255,0.02);padding:8px;border-radius:8px;font-size:12px;opacity:.7}

.controlsBottom{grid-column:1/-1;display:flex;justify-content:space-between;padding:8px 18px}
.golden{position:fixed;right:40px;bottom:40px;background:linear-gradient(135deg,#fff4b8,#ffd36b);padding:12px;border-radius:12px;cursor:pointer;box-shadow:0 12px 30px rgba(0,0,0,.18);display:none}

/* Audio UI */
.audioControls{display:flex;flex-direction:column;gap:8px;padding:8px;background:rgba(255,255,255,0.03);border-radius:8px;margin-top:12px}
.slider{width:100%}

/* Particle */
.particle{position:fixed;font-size:18px;pointer-events:none;transition:transform 900ms ease, opacity 900ms ease}

/* Notifications */
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:24px;background:rgba(255,255,255,0.95);color:#072d24;padding:8px 12px;border-radius:10px;box-shadow:0 12px 30px rgba(0,0,0,.2);font-weight:700}

@media (max-width:980px){
  .game{grid-template-columns:1fr;grid-auto-rows:auto;padding:8px}
  .sidebar{height:auto}
  .mangoBtn{width:220px;height:220px;font-size:92px}
}
</style>
<body>
<div id="game" class="game" aria-live="polite">
  <div class="header">
    <div class="brand">
      <div class="logo">ü•≠</div>
      <div class="title">
        <h1 id="gameTitle">MangoTree - Fazenda das Mangas</h1>
        <small id="gameTag">Clique na manga. Seja o fazeendeiro das Mangas.</small>
      </div>
    </div>
    <div class="hud">
      <div class="statBox"><div class="small">Mangoes</div><div id="mangoCount" class="bigNum">0</div></div>
      <div class="statBox"><div class="small">MPS</div><div id="mps" class="bigNum">0</div></div>
      <button id="langBtn" class="langToggle">PT / EN</button>
    </div>
  </div>

  <div class="play">
    <div id="scene" class="scene">
      <div class="sky">
        <div id="sun" class="sun">‚òÄÔ∏è</div>
        <div id="birds" class="birds">üê¶ üê¶</div>
      </div>

      <div id="trees" class="trees"></div>

      <div class="center">
        <div id="mangoBtn" class="mangoBtn" title="Click">ü•≠</div>
      </div>

      <div class="ground">üå¥üåøüå±üå≥üå¥</div>
    </div>

    <div class="hudRow">
      <div class="statBox small"><div>Per Click</div><div id="mpc" class="bigNum">1</div></div>
      <div class="statBox small"><div>Total Harvested</div><div id="totalHarvest" class="bigNum">0</div></div>
      <div class="statBox small"><div>Ascension</div><div id="ascPoints" class="bigNum">0</div></div>
      <div style="flex:1"></div>
      <div class="controls">
        <button id="exportBtn" class="btn ghost">Export</button>
        <button id="importBtn" class="btn ghost">Import</button>
        <button id="saveBtn" class="btn ghost">Save</button>
        <button id="resetBtn" class="btn">Ascend</button>
      </div>
    </div>
  </div>

  <aside class="sidebar">
    <h3 id="buildTitle">Funcion√°rios & Edif√≠cios</h3>
    <div id="buildingsList"></div>

    <h3 id="upgTitle">Melhorias</h3>
    <div id="upgradesList" class="upgGrid"></div>

    <h3 id="achTitle">Conquistas</h3>
    <div id="achList" class="achRow"></div>

    <div class="audioControls">
      <div><label>Ambient volume <input id="volAmbient" class="slider" type="range" min="0" max="1" step="0.01" value="0.6"></label></div>
      <div><label>Effects volume <input id="volEffects" class="slider" type="range" min="0" max="1" step="0.01" value="0.9"></label></div>
      <div><label>Toggle ambient <button id="toggleAmbient" class="btn ghost">Play</button></label></div>
    </div>
  </aside>

  <div class="controlsBottom">
    <div id="autoSaveText">Autosave: ON</div>
    <div id="bgStageText">Cen√°rio: 1</div>
  </div>
</div>

<div id="golden" class="golden" title="Golden Mango!">‚ú®ü•≠</div>

<!-- Audio elements (place your files in ./audio/) -->
<audio id="audioAmbient" loop preload="auto">
  <source src="./audio/ambient.mp3" type="audio/mpeg">
  <source src="./audio/ambient.ogg" type="audio/ogg">
  <source src="./audio/ambient.wav" type="audio/wav">
</audio>
<audio id="audioClick" preload="auto">
  <source src="./audio/click.mp3" type="audio/mpeg">
  <source src="./audio/click.ogg" type="audio/ogg">
  <source src="./audio/click.wav" type="audio/wav">
</audio>
<audio id="audioUpgrade" preload="auto">
  <source src="./audio/upgrade.mp3" type="audio/mpeg">
  <source src="./audio/upgrade.ogg" type="audio/ogg">
  <source src="./audio/upgrade.wav" type="audio/wav">
</audio>
<audio id="audioAchieve" preload="auto">
  <source src="./audio/achieve.mp3" type="audio/mpeg">
  <source src="./audio/achieve.ogg" type="audio/ogg">
  <source src="./audio/achieve.wav" type="audio/wav">
</audio>

<script>
/* MangoTree - vers√£o final integrada: otimiza√ß√µes + anti-cheat
   - Anti-autoclick (1 click/sec + pattern detection)
   - Stable WebAudio with AudioBuffer effects (no cutting)
   - Varied click sound (playbackRate / detune / panner)
   - Engine optimizations: dirty render, capped particles, debounced save
*/

/* ======= CONFIG & BALANCE ======= */
const IMAGES = ['./img/background-1.jpg','./img/background-2.jpg','./img/background-3.jpg'];
const SAVE_KEY = 'mangotree_final_save_v3';
let LANG = localStorage.getItem('mango_lang') || 'pt';

const STRINGS = {
  pt: {
    title:'MangoTree - Fazenda das Mangas',
    tag:'Clique na manga. Fa√ßa as Mangas.',
    build:'Funcion√°rios & Edif√≠cios', upg:'Melhorias', ach:'Conquistas',
    autosaveOn:'Autosave: ON', stage:(n)=>`Cen√°rio: ${n}`,
    save:'Salvar', export:'Exportar', imp:'Importar', asc:'Ascender', tutorial:'Clique na manga para come√ßar!'
  },
  en: {
    title:'MangoTree - Farmer of Mangoes',
    tag:'Click the mango. Become a Mango Farmer.',
    build:'Workers & Buildings', upg:'Upgrades', ach:'Achievements',
    autosaveOn:'Autosave: ON', stage:(n)=>`Stage: ${n}`,
    save:'Save', export:'Export', imp:'Import', asc:'Ascend', tutorial:'Click the mango to get started!'
  }
};

const BUILDINGS = [
  {id:'picker', name_en:'Picker', name_pt:'Colhedor', baseCost:15, baseCps:0.12, icon:'üßë‚Äçüåæ'},
  {id:'farmer', name_en:'Farmhand', name_pt:'Trabalhador', baseCost:120, baseCps:1.4, icon:'üë®‚Äçüåæ'},
  {id:'orchard', name_en:'Orchard', name_pt:'Pomar', baseCost:1300, baseCps:9, icon:'üå≥'},
  {id:'farm', name_en:'Tropical Farm', name_pt:'Fazenda Tropical', baseCost:14000, baseCps:48, icon:'üèùÔ∏è'},
  {id:'sanct', name_en:'Sanctuary', name_pt:'Santu√°rio', baseCost:160000, baseCps:320, icon:'üèõÔ∏è'}
];

const UPGRADES = [
  {id:'claws', name_en:'Sharp Claws', name_pt:'Garras Afiadas', desc_en:'+1 per click', desc_pt:'+1 por clique', cost:600, apply:s=> s.mpc += 1},
  {id:'baskets', name_en:'Large Baskets', name_pt:'Cestos Grandes', desc_en:'+3 per click', desc_pt:'+3 por clique', cost:3000, apply:s=> s.mpc += 3},
  {id:'fert', name_en:'Ancestral Fertilizer', name_pt:'Fertilizante Ancestral', desc_en:'x2 production', desc_pt:'x2 produ√ß√£o', cost:8000, apply:s=> s.multiplier *= 2},
  {id:'irrig', name_en:'Irrigation Runes', name_pt:'Runas de Irriga√ß√£o', desc_en:'+20% production', desc_pt:'+20% produ√ß√£o', cost:25000, apply:s=> s.multiplier *= 1.2}
];

const ACHIEVEMENTS = [
  {id:'first', name_en:'First Bite', name_pt:'Primeira Mordida', desc_en:'Click for the first time', desc_pt:'Clique pela primeira vez', check:s=> s.totalHarvest>=1},
  {id:'hundred', name_en:'Century', name_pt:'Cem', desc_en:'Harvest 100 mangoes', desc_pt:'Colete 100 mangas', check:s=> s.totalHarvest>=100},
  {id:'farmhand', name_en:'Employers', name_pt:'Empregadores', desc_en:'Hire 10 farmhands', desc_pt:'Contrate 10 trabalhadores', check:s=> (s.buildings['farmer'] && s.buildings['farmer'].count>=10)},
  {id:'million', name_en:'Mango Magnate', name_pt:'Magnata das Mangas', desc_en:'Harvest 1,000,000', desc_pt:'Colete 1.000.000 mangas', check:s=> s.totalHarvest>=1000000}
];

const STAGE_THRESHOLDS = [0, 1000, 20000, 200000];

/* Anti-cheat constants */
const ANTI_CLICK_MIN_INTERVAL = 1000; // ms between allowed clicks
const BOT_PATTERN_WINDOW = 5; // how many intervals to track
const BOT_PATTERN_MAX_VARIATION = 10; // ms tolerance
const BOT_PATTERN_MAX_INTERVAL = 120; // ms (fast autoclickers)
const BOT_PENALTY_MS = 0; // penalty duration when detected

/* ======= STATE ======= */
let state = {
  mango:0,
  totalHarvest:0,
  mpc:1,
  multiplier:1,
  buildings:{},
  upgrades:[],
  achievements:[],
  ascendPoints:0,
  stageIndex:0,
  lastTick: Date.now()
};
BUILDINGS.forEach(b => state.buildings[b.id] = {count:0});

/* ======= DOM refs ======= */
const gameEl = document.getElementById('game');
const mangoBtn = document.getElementById('mangoBtn');
const mangoCountEl = document.getElementById('mangoCount');
const mpsEl = document.getElementById('mps');
const mpcEl = document.getElementById('mpc');
const totalHarvestEl = document.getElementById('totalHarvest');
const ascEl = document.getElementById('ascPoints');
const treesEl = document.getElementById('trees');
const buildingsList = document.getElementById('buildingsList');
const upgradesList = document.getElementById('upgradesList');
const achList = document.getElementById('achList');
const exportBtn = document.getElementById('exportBtn');
const importBtn = document.getElementById('importBtn');
const saveBtn = document.getElementById('saveBtn');
const resetBtn = document.getElementById('resetBtn');
const autoSaveText = document.getElementById('autoSaveText');
const langBtn = document.getElementById('langBtn');
const gameTitleEl = document.getElementById('gameTitle');
const gameTagEl = document.getElementById('gameTag');
const buildTitleEl = document.getElementById('buildTitle');
const upgTitleEl = document.getElementById('upgTitle');
const achTitleEl = document.getElementById('achTitle');
const bgStageText = document.getElementById('bgStageText');
const goldenEl = document.getElementById('golden');
const sceneEl = document.getElementById('scene');
const volAmbientEl = document.getElementById('volAmbient');
const volEffectsEl = document.getElementById('volEffects');
const toggleAmbientBtn = document.getElementById('toggleAmbient');

const audioAmbientEl = document.getElementById('audioAmbient');
const audioClickEl = document.getElementById('audioClick');
const audioUpgradeEl = document.getElementById('audioUpgrade');
const audioAchieveEl = document.getElementById('audioAchieve');

/* ======= AUDIO (WebAudio optimized) ======= */
let audioCtx = null, masterGain=null, ambientGain=null, effectsGain=null;
let ambientSource = null;
const audioBuffers = {}; // name -> AudioBuffer
let audioReady = false;

async function decodeArrayBuffer(arr){
  try{ return await audioCtx.decodeAudioData(arr); }
  catch(e){
    // fallback for older implementations
    return await new Promise((resolve,reject)=> audioCtx.decodeAudioData(arr, resolve, reject));
  }
}

async function initAudioOnce(){
  if(audioReady) return;
  try{
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    masterGain = audioCtx.createGain();
    ambientGain = audioCtx.createGain();
    effectsGain = audioCtx.createGain();
    masterGain.connect(audioCtx.destination);
    ambientGain.connect(masterGain);
    effectsGain.connect(masterGain);
    masterGain.gain.value = 0.95;
    ambientGain.gain.value = parseFloat(volAmbientEl.value || 0.6);
    effectsGain.gain.value = parseFloat(volEffectsEl.value || 0.9);

    try{
      ambientSource = audioCtx.createMediaElementSource(audioAmbientEl);
      const ambientFilter = audioCtx.createBiquadFilter();
      ambientFilter.type = 'lowpass'; ambientFilter.frequency.value = 8000;
      ambientSource.connect(ambientFilter);
      ambientFilter.connect(ambientGain);
    }catch(e){ console.warn('Ambient source via WebAudio failed:', e); }

    // try to pre-load effect buffers
    await Promise.all([
      loadBufferFromMediaElement(audioClickEl, 'click'),
      loadBufferFromMediaElement(audioUpgradeEl, 'upgrade'),
      loadBufferFromMediaElement(audioAchieveEl, 'achieve')
    ]).catch(e=>{ console.warn('Erro carregando buffers:', e); });

    audioReady = true;
  }catch(e){ console.warn('initAudioOnce error', e); }
}

async function loadBufferFromMediaElement(mediaEl, name){
  const src = (mediaEl.querySelector && mediaEl.querySelector('source') && mediaEl.querySelector('source').src) || mediaEl.src;
  if(!src) return;
  try{
    const res = await fetch(src);
    const arr = await res.arrayBuffer();
    audioBuffers[name] = await decodeArrayBuffer(arr);
  }catch(e){ console.warn('loadBufferFromMediaElement failed', name, e); }
}

function playBuffer(name){
  if(!audioCtx || !audioBuffers[name]){
    // fallback to HTML audio element
    const el = name === 'click' ? audioClickEl : (name === 'upgrade' ? audioUpgradeEl : audioAchieveEl);
    if(el){ try{ el.currentTime = 0; el.play().catch(()=>{}); }catch(e){} }
    return;
  }
  try{
    const src = audioCtx.createBufferSource();
    src.buffer = audioBuffers[name];
    // vary pitch slightly
    src.playbackRate.value = 0.92 + Math.random()*0.18;
    // small detune for variety (cents)
    try{ src.detune.value = (Math.random()*200 - 100); }catch(e){}
    const panner = audioCtx.createStereoPanner();
    panner.pan.value = (Math.random()*2 - 1) * 0.3;
    src.connect(panner);
    panner.connect(effectsGain);
    src.start(0);
  }catch(e){ console.warn('playBuffer error', e); }
}

function resumeAudioContext(){ if(audioCtx && audioCtx.state === 'suspended') audioCtx.resume().catch(()=>{}); }

volAmbientEl.addEventListener('input', ()=>{ if(ambientGain) ambientGain.gain.value = parseFloat(volAmbientEl.value); });
volEffectsEl.addEventListener('input', ()=>{ if(effectsGain) effectsGain.gain.value = parseFloat(volEffectsEl.value); });

let ambientStarted = false;
function startAmbientIfNeeded(){
  if(ambientStarted) return;
  initAudioOnce().then(()=>{ resumeAudioContext(); audioAmbientEl.play().catch(()=>{}); ambientStarted = true; toggleAmbientBtn.textContent = LANG === 'en' ? 'Pause' : 'Pausar'; });
}

document.addEventListener('pointerdown', startAmbientIfNeeded, {once:true});

toggleAmbientBtn.addEventListener('click', ()=>{ if(!ambientStarted){ startAmbientIfNeeded(); return; } if(audioAmbientEl.paused){ audioAmbientEl.play().catch(()=>{}); toggleAmbientBtn.textContent = LANG === 'en' ? 'Pause' : 'Pausar'; } else { audioAmbientEl.pause(); toggleAmbientBtn.textContent = LANG === 'en' ? 'Play' : 'Tocar'; } });

/* ======= UTIL ======= */
function fmt(n){ if(n>=1e9) return (n/1e9).toFixed(2)+'B'; if(n>=1e6) return (n/1e6).toFixed(2)+'M'; if(n>=1e3) return (n/1e3).toFixed(2)+'k'; return Math.floor(n).toString(); }

/* ======= RENDER (dirty flag) ======= */
let renderRequested = false;
function markDirty(){ if(!renderRequested){ renderRequested = true; requestAnimationFrame(renderAll); } }

function renderTrees(){ treesEl.innerHTML = ''; const count = Math.min(6, 1 + Math.floor(state.totalHarvest / 750)); for(let i=0;i<count;i++){ const div = document.createElement('div'); div.className = 'tree'; const size = 46 + (i%3)*8; div.style.fontSize = size + 'px'; div.style.left = (i*140) + 'px'; div.textContent = 'üå≥'; treesEl.appendChild(div); } }
function renderBuildings(){ buildingsList.innerHTML = ''; BUILDINGS.forEach(def=>{ const have = state.buildings[def.id].count || 0; const cost = getBuildingCost(def, have); const wrapper = document.createElement('div'); wrapper.className = 'building'; wrapper.innerHTML = ` <div> <div style="font-weight:800">${def.icon} ${LANG==='en'?def.name_en:def.name_pt}</div> <small class="small">${def.baseCps} mangoes/s each</small> </div> <div style="text-align:right"> <div class="small">Cost: <strong>${fmt(cost)}</strong></div> <div style="margin-top:8px"><button class="btn" data-buy="${def.id}" data-cost="${cost}">${LANG==='en'?'Buy':'Comprar'}</button></div> <div style="margin-top:8px" class="small">Owned: <strong>${have}</strong></div> </div>`; buildingsList.appendChild(wrapper); }); }
function renderUpgrades(){ upgradesList.innerHTML = ''; UPGRADES.forEach(u=>{ if(state.upgrades.includes(u.id)) return; const el = document.createElement('div'); el.className='upgrade'; el.innerHTML = `<div style="font-weight:700">${LANG==='en'?u.name_en:u.name_pt}</div><div class="small">${LANG==='en'?u.desc_en:u.desc_pt}</div><div style="margin-top:6px"><button class="btn" data-upgrade="${u.id}" data-cost="${u.cost}">${fmt(u.cost)}</button></div>`; upgradesList.appendChild(el); }); }
function renderAchievements(){ achList.innerHTML = ''; ACHIEVEMENTS.forEach(a=>{ const have = state.achievements.includes(a.id); const el = document.createElement('div'); el.className='ach'; el.style.opacity = have ? 1 : 0.45; el.innerHTML = `<div style="font-weight:700">${LANG==='en'?a.name_en:a.name_pt}</div><div class="small">${LANG==='en'?a.desc_en:a.desc_pt}</div>`; achList.appendChild(el); }); }
function renderHUD(){ const mps = computeCps(); mangoCountEl.textContent = fmt(Math.floor(state.mango)); mpsEl.textContent = mps.toFixed(2); mpcEl.textContent = Math.floor(state.mpc * state.multiplier); totalHarvestEl.textContent = fmt(Math.floor(state.totalHarvest)); ascEl.textContent = state.ascendPoints; bgStageText.textContent = STRINGS[LANG].stage(state.stageIndex+1); }
function renderAll(){ renderRequested = false; renderTrees(); renderBuildings(); renderUpgrades(); renderAchievements(); renderHUD(); applyBackground(); }

/* ======= MECHANICS ======= */
function getBuildingCost(def, have){ return Math.floor(def.baseCost * Math.pow(1.15, have)); }
function computeCps(){ let cps = 0; for(let i=0;i<BUILDINGS.length;i++){ const b = BUILDINGS[i]; cps += b.baseCps * ((state.buildings[b.id] && state.buildings[b.id].count) || 0); } cps *= state.multiplier; return cps; }

/* Purchase handlers */
document.addEventListener('click', (e)=>{ const buy = e.target.closest('[data-buy]'); if(buy){ const id = buy.getAttribute('data-buy'); buyBuilding(id); markDirty(); } const up = e.target.closest('[data-upgrade]'); if(up){ const id = up.getAttribute('data-upgrade'); buyUpgrade(id); markDirty(); } });
function buyBuilding(id){ const def = BUILDINGS.find(x=>x.id===id); const have = state.buildings[id].count || 0; const cost = getBuildingCost(def, have); if(state.mango >= cost){ state.mango -= cost; state.buildings[id].count++; playBuffer('upgrade'); flash((LANG==='en' ? def.name_en : def.name_pt) + ' bought'); markDirty(); } else flash(LANG==='en' ? 'Not enough mangoes' : 'Mangas insuficientes'); }
function buyUpgrade(id){ const u = UPGRADES.find(x=>x.id===id); if(!u) return; if(state.mango >= u.cost){ state.mango -= u.cost; state.upgrades.push(u.id); u.apply(state); playBuffer('upgrade'); flash(LANG==='en' ? 'Upgrade acquired' : 'Melhoria adquirida'); markDirty(); } else flash(LANG==='en' ? 'Not enough mangoes' : 'Mangas insuficientes'); }

/* ======= Anti-autoclick logic ======= */
let lastClickTime = 0;
let clickIntervals = [];
let antiCheatTimeout = null;

function antiCheatCheck(){
  const now = performance.now();
  const interval = lastClickTime ? now - lastClickTime : Infinity; // first click - allow
  if(lastClickTime){ clickIntervals.push(interval); if(clickIntervals.length > BOT_PATTERN_WINDOW) clickIntervals.shift(); }
  lastClickTime = now;

  if(clickIntervals.length >= BOT_PATTERN_WINDOW){
    const avg = clickIntervals.reduce((a,b)=>a+b,0)/clickIntervals.length;
    const isBotPattern = clickIntervals.every(t => Math.abs(t - avg) < BOT_PATTERN_MAX_VARIATION && t < BOT_PATTERN_MAX_INTERVAL);
    if(isBotPattern){
      console.warn('AntiCheat: bot pattern detected', {avg, intervals: clickIntervals.slice()});
      if(!antiCheatTimeout){ antiCheatTimeout = setTimeout(()=>{ antiCheatTimeout = null; clickIntervals = []; }, BOT_PENALTY_MS); }
      return {ok:false, reason:'bot_pattern'};
    }
  }

  if(interval < ANTI_CLICK_MIN_INTERVAL){
    // too fast, but not necessarily a bot pattern - just ignore this single click
    return {ok:false, reason:'too_fast'};
  }

  return {ok:true};
}

function showAntiCheatWarning(reason){
  if(reason === 'bot_pattern') flash(LANG==='en'?'Autoclicker detected! Temporarily blocked.':'Autoclicker detectado! Bloqueado temporariamente.');
  else flash(LANG==='en'?'Too fast! Slow down.':'Muito r√°pido! Respire.');
}

/* Click mango (uses anti-cheat) */
const MAX_PARTICLES = 512;
mangoBtn.addEventListener('click',(ev)=>{
  const check = antiCheatCheck();
  if(!check.ok){ showAntiCheatWarning(check.reason); return; }
  const gain = state.mpc * state.multiplier;
  state.mango += gain;
  state.totalHarvest += gain;
  spawnParticles(ev.clientX, ev.clientY, Math.min(MAX_PARTICLES, 12));
  playBuffer('click');
  checkAchievements();
  maybeSpawnGolden();
  markDirty();
});

/* Particles */
function spawnParticles(x,y,n=8){ const emojis = ['ü•≠','üåø','üå∏','üçÉ','üå∫','‚ú®']; for(let i=0;i<n;i++){ const p = document.createElement('div'); p.className = 'particle'; p.style.left = (x + (Math.random()*120 - 60)) + 'px'; p.style.top = (y + (Math.random()*80 - 40)) + 'px'; p.textContent = emojis[Math.floor(Math.random()*emojis.length)]; p.style.fontSize = (12 + Math.random()*28) + 'px'; document.body.appendChild(p); requestAnimationFrame(()=>{ p.style.transform = `translate(${Math.random()*80-40}px, ${-140 - Math.random()*80}px) rotate(${Math.random()*360}deg)`; p.style.opacity = 0; }); setTimeout(()=> p.remove(), 1200); } }

/* Golden mango */
function maybeSpawnGolden(){ if(Math.random() < 0.015){ goldenEl.style.display = 'block'; setTimeout(()=> goldenEl.style.display = 'none', 11000); } }
goldenEl.addEventListener('click', ()=>{ const bonus = Math.max(50, Math.floor(state.totalHarvest * 0.02)); state.mango += bonus; playBuffer('achieve'); flash((LANG==='en'?'Golden mango! +':'Manga dourada! +') + bonus); goldenEl.style.display = 'none'; markDirty(); });

/* ======= Tick & Offline ======= */
let last = Date.now();
function tick(){ const now = Date.now(); const dt = (now - last) / 1000; last = now; const cps = computeCps(); const gain = cps * dt; if(gain>0){ state.mango += gain; state.totalHarvest += gain; checkAchievements(); updateStageLogic(); markDirty(); } }
setInterval(tick,2500);

/* Offline gain loader */
function load(){ const raw = localStorage.getItem(SAVE_KEY); if(!raw) return; try{ const s = JSON.parse(raw); state = Object.assign(state, s); BUILDINGS.forEach(b => state.buildings[b.id] = state.buildings[b.id] || {count:0}); const now = Date.now(); const dt = Math.max(0, (now - (state.lastTick||now))/1000); const offlineGain = computeCps() * dt; if(offlineGain > 0){ state.mango += offlineGain; state.totalHarvest += offlineGain; flash((LANG==='en'?'Offline gain: ':'Ganho offline: ') + Math.floor(offlineGain)); } }catch(e){ console.error(e); } }

/* ======= Save & export/import (debounced) ======= */
function doSave(){ state.lastTick = Date.now(); localStorage.setItem(SAVE_KEY, JSON.stringify(state)); flash(LANG==='en' ? 'Saved' : 'Salvo'); }
let saveTimer = null; function scheduleSave(){ if(saveTimer) clearTimeout(saveTimer); saveTimer = setTimeout(()=>{ doSave(); saveTimer = null; }, 800); }
saveBtn.addEventListener('click', ()=>{ doSave(); }); setInterval(()=>{ scheduleSave(); }, 9000);
exportBtn.addEventListener('click', ()=>{ const txt = localStorage.getItem(SAVE_KEY) || JSON.stringify(state); const blob = new Blob([txt], {type:'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'mangotree_save.json'; a.click(); URL.revokeObjectURL(url); });
importBtn.addEventListener('click', ()=>{ const inp = document.createElement('input'); inp.type = 'file'; inp.accept = '.json'; inp.onchange = ()=>{ const f = inp.files[0]; const r = new FileReader(); r.onload = ()=>{ try{ localStorage.setItem(SAVE_KEY, r.result); flash(LANG==='en'?'Imported':'Importado'); location.reload(); }catch(e){ alert('Invalid file'); } }; r.readAsText(f); }; inp.click(); });

/* ======= Achievements & checks ======= */
function checkAchievements(){ ACHIEVEMENTS.forEach(a=>{ if(!state.achievements.includes(a.id) && a.check(state)){ state.achievements.push(a.id); playBuffer('achieve'); flash((LANG==='en'?a.name_en:a.name_pt) + ' unlocked!'); markDirty(); } }); }

/* ======= Ascend ======= */
resetBtn.addEventListener('click', ()=>{ if(!confirm(LANG==='en' ? 'Perform Ascension? You gain 1 point per 10,000 total harvested.' : 'Deseja realizar a Ascens√£o? Voc√™ ganha 1 ponto por cada 10.000 mangas totais.')) return; const points = Math.floor(state.totalHarvest / 10000); state = {mango:0,totalHarvest:0,mpc:1,multiplier:1,buildings:{},upgrades:[],achievements:[],ascendPoints:(state.ascendPoints||0)+points,stageIndex:0,lastTick:Date.now()}; BUILDINGS.forEach(b=> state.buildings[b.id] = {count:0}); state.multiplier *= 1 + (state.ascendPoints * 0.02); doSave(); flash((LANG==='en'?'Ascended +':'Ascendido +') + points); markDirty(); });

/* ======= Stage / background logic ======= */
function applyBackground(){ const idx = Math.max(0, Math.min(IMAGES.length-1, state.stageIndex)); const img = IMAGES[idx] || ''; if(img) gameEl.style.backgroundImage = `url("${img}")`; }
function updateStageLogic(){ let newStage = 0; for(let i=0;i<STAGE_THRESHOLDS.length;i++){ if(state.totalHarvest >= STAGE_THRESHOLDS[i]) newStage = i; } if(state.totalHarvest > STAGE_THRESHOLDS[STAGE_THRESHOLDS.length-1]){ const cycleLen = STAGE_THRESHOLDS[STAGE_THRESHOLDS.length-1] * 2; newStage = Math.floor((state.totalHarvest / cycleLen) % IMAGES.length); } if(newStage !== state.stageIndex){ state.stageIndex = newStage; playBuffer('upgrade'); flash((LANG==='en'?'Stage changed to ':'Cen√°rio mudou para ') + (state.stageIndex+1)); markDirty(); applyBackground(); } }

/* ======= Toast/Flash ======= */
function flash(text){ const d = document.createElement('div'); d.className='toast'; d.textContent = text; document.body.appendChild(d); setTimeout(()=>{ d.style.transition='all 700ms'; d.style.bottom='64px'; d.style.opacity=0 },700); setTimeout(()=> d.remove(),1500); }

/* ======= Interaction & language ======= */
document.getElementById('langBtn').addEventListener('click', ()=>{ LANG = LANG === 'en' ? 'pt' : 'en'; localStorage.setItem('mango_lang', LANG); applyLang(); markDirty(); });
function applyLang(){ document.getElementById('gameTitle').textContent = STRINGS[LANG].title; document.getElementById('gameTag').textContent = STRINGS[LANG].tag; document.getElementById('buildTitle').textContent = STRINGS[LANG].build; document.getElementById('upgTitle').textContent = STRINGS[LANG].upg; document.getElementById('achTitle').textContent = STRINGS[LANG].ach; document.getElementById('saveBtn').textContent = STRINGS[LANG].save; document.getElementById('exportBtn').textContent = STRINGS[LANG].export; document.getElementById('importBtn').textContent = STRINGS[LANG].imp; document.getElementById('resetBtn').textContent = STRINGS[LANG].asc; document.getElementById('autoSaveText').textContent = STRINGS[LANG].autosaveOn; document.getElementById('bgStageText').textContent = STRINGS[LANG].stage(state.stageIndex+1); }
applyLang();

/* initialize audio on user gesture to comply with autoplay policies */
document.addEventListener('pointerdown', function startAudioOnce(){ initAudioOnce().then(()=>resumeAudioContext()); document.removeEventListener('pointerdown', startAudioOnce); });

/* ======= Load, render and start ======= */
load(); renderAll(); if(!localStorage.getItem('mango_seen_tutorial')){ flash(STRINGS[LANG].tutorial); localStorage.setItem('mango_seen_tutorial','1'); }

/* Keyboard save */
window.addEventListener('keydown',(e)=>{ if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='s'){ e.preventDefault(); doSave(); } });

</script>
</body>
</html>
